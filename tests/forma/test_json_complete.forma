# Complete JSON Functionality Test
# Tests ALL json_* builtins and stdlib functions

# Import stdlib json utilities
us std.json

# ============================================================
# Test JSON Parsing
# ============================================================

f test_json_parse_object() -> Bool
    json_str := "{\"name\": \"Alice\", \"age\": 30}"
    m json_parse(json_str)
        Ok(json) ->
            m json_get_str(json, "name")
                Some(name) -> name == "Alice"
                None -> false
        Err(_) -> false

f test_json_parse_array() -> Bool
    json_str := "[1, 2, 3, 4, 5]"
    m json_parse(json_str)
        Ok(json) ->
            json_array_len(json) == 5
        Err(_) -> false

f test_json_parse_nested() -> Bool
    json_str := "{\"user\": {\"name\": \"Bob\", \"email\": \"bob@example.com\"}}"
    m json_parse(json_str)
        Ok(json) ->
            m json_get(json, "user")
                Some(user) ->
                    m json_get_str(user, "email")
                        Some(email) -> email == "bob@example.com"
                        None -> false
                None -> false
        Err(_) -> false

f test_json_parse_invalid() -> Bool
    json_str := "{invalid json}"
    m json_parse(json_str)
        Ok(_) -> false
        Err(_) -> true

# ============================================================
# Test JSON Creation
# ============================================================

f test_json_from_str() -> Bool
    json := json_from_str("hello")
    json_is_string(json)

f test_json_from_int() -> Bool
    json := json_from_int(42)
    json_is_number(json)

f test_json_from_float() -> Bool
    json := json_from_float(3.14)
    json_is_number(json)

f test_json_from_bool() -> Bool
    json := json_from_bool(true)
    json_is_bool(json)

f test_json_null() -> Bool
    json := json_null()
    json_is_null(json)

f test_json_object_empty() -> Bool
    json := json_object()
    json_is_object(json) && vec_len(json_keys(json)) == 0

f test_json_array_empty() -> Bool
    json := json_array()
    json_is_array(json) && json_array_len(json) == 0

# ============================================================
# Test JSON Manipulation
# ============================================================

f test_json_set() -> Bool
    json := json_object()
    json2 := json_set(json, "name", json_from_str("Charlie"))
    m json_get_str(json2, "name")
        Some(name) -> name == "Charlie"
        None -> false

f test_json_keys() -> Bool
    json_str := "{\"a\": 1, \"b\": 2, \"c\": 3}"
    m json_parse(json_str)
        Ok(json) ->
            keys := json_keys(json)
            vec_len(keys) == 3
        Err(_) -> false

f test_json_values() -> Bool
    json_str := "{\"x\": 10, \"y\": 20}"
    m json_parse(json_str)
        Ok(json) ->
            values := json_values(json)
            vec_len(values) == 2
        Err(_) -> false

f test_json_has() -> Bool
    json_str := "{\"exists\": true}"
    m json_parse(json_str)
        Ok(json) ->
            json_has(json, "exists") && !json_has(json, "missing")
        Err(_) -> false

# ============================================================
# Test JSON Array Operations
# ============================================================

f test_json_array_get() -> Bool
    json_str := "[\"a\", \"b\", \"c\"]"
    m json_parse(json_str)
        Ok(json) ->
            m json_array_get(json, 1)
                Some(elem) ->
                    json_is_string(elem)
                None -> false
        Err(_) -> false

# ============================================================
# Test JSON Type Checking
# ============================================================

f test_json_type() -> Bool
    str_json := json_from_str("test")
    int_json := json_from_int(42)
    bool_json := json_from_bool(false)
    null_json := json_null()

    (json_type(str_json) == "string") && (json_type(int_json) == "number") && (json_type(bool_json) == "bool") && (json_type(null_json) == "null")

f test_json_is_predicates() -> Bool
    json_is_string(json_from_str("x")) && json_is_number(json_from_int(1)) && json_is_bool(json_from_bool(true)) && json_is_null(json_null()) && json_is_object(json_object()) && json_is_array(json_array())

# ============================================================
# Test JSON Stringify
# ============================================================

f test_json_stringify() -> Bool
    json := json_object()
    json = json_set(json, "key", json_from_str("value"))
    str := json_stringify(json)
    str_contains(str, "key") && str_contains(str, "value")

f test_json_stringify_pretty() -> Bool
    json := json_object()
    json = json_set(json, "formatted", json_from_bool(true))
    str := json_stringify_pretty(json)
    str_contains(str, "formatted")

# ============================================================
# Test Stdlib Utility Functions (from std/json.forma)
# ============================================================

f test_json_get_str_or() -> Bool
    json_str := "{\"name\": \"Dave\"}"
    m json_parse(json_str)
        Ok(json) ->
            val1 := json_get_str_or(json, "name", "default")
            val2 := json_get_str_or(json, "missing", "default")
            val1 == "Dave" && val2 == "default"
        Err(_) -> false

f test_json_get_int_or() -> Bool
    json_str := "{\"count\": 42}"
    m json_parse(json_str)
        Ok(json) ->
            val1 := json_get_int_or(json, "count", 0)
            val2 := json_get_int_or(json, "missing", 99)
            val1 == 42 && val2 == 99
        Err(_) -> false

f test_json_is_empty() -> Bool
    empty_obj := json_object()
    empty_arr := json_array()
    non_empty := json_set(json_object(), "x", json_from_int(1))

    json_is_empty(empty_obj) && json_is_empty(empty_arr) && !json_is_empty(non_empty)

f test_json_path() -> Bool
    json_str := "{\"user\": {\"profile\": {\"name\": \"Eve\"}}}"
    m json_parse(json_str)
        Ok(json) ->
            m json_path(json, "user.profile.name")
                Some(name_json) ->
                    json_is_string(name_json)
                None -> false
        Err(_) -> false

# ============================================================
# Run All Tests
# ============================================================

f main() -> Int
    passed := 0
    total := 24

    # Parsing tests
    if test_json_parse_object()
        passed = passed + 1
        print("PASS: parse_object")
    else
        print("FAIL: parse_object")

    if test_json_parse_array()
        passed = passed + 1
        print("PASS: parse_array")
    else
        print("FAIL: parse_array")

    if test_json_parse_nested()
        passed = passed + 1
        print("PASS: parse_nested")
    else
        print("FAIL: parse_nested")

    if test_json_parse_invalid()
        passed = passed + 1
        print("PASS: parse_invalid")
    else
        print("FAIL: parse_invalid")

    # Creation tests
    if test_json_from_str()
        passed = passed + 1
        print("PASS: from_str")
    else
        print("FAIL: from_str")

    if test_json_from_int()
        passed = passed + 1
        print("PASS: from_int")
    else
        print("FAIL: from_int")

    if test_json_from_float()
        passed = passed + 1
        print("PASS: from_float")
    else
        print("FAIL: from_float")

    if test_json_from_bool()
        passed = passed + 1
        print("PASS: from_bool")
    else
        print("FAIL: from_bool")

    if test_json_null()
        passed = passed + 1
        print("PASS: null")
    else
        print("FAIL: null")

    if test_json_object_empty()
        passed = passed + 1
        print("PASS: object_empty")
    else
        print("FAIL: object_empty")

    if test_json_array_empty()
        passed = passed + 1
        print("PASS: array_empty")
    else
        print("FAIL: array_empty")

    # Manipulation tests
    if test_json_set()
        passed = passed + 1
        print("PASS: set")
    else
        print("FAIL: set")

    if test_json_keys()
        passed = passed + 1
        print("PASS: keys")
    else
        print("FAIL: keys")

    if test_json_values()
        passed = passed + 1
        print("PASS: values")
    else
        print("FAIL: values")

    if test_json_has()
        passed = passed + 1
        print("PASS: has")
    else
        print("FAIL: has")

    if test_json_array_get()
        passed = passed + 1
        print("PASS: array_get")
    else
        print("FAIL: array_get")

    # Type tests
    if test_json_type()
        passed = passed + 1
        print("PASS: type")
    else
        print("FAIL: type")

    if test_json_is_predicates()
        passed = passed + 1
        print("PASS: is_predicates")
    else
        print("FAIL: is_predicates")

    # Stringify tests
    if test_json_stringify()
        passed = passed + 1
        print("PASS: stringify")
    else
        print("FAIL: stringify")

    if test_json_stringify_pretty()
        passed = passed + 1
        print("PASS: stringify_pretty")
    else
        print("FAIL: stringify_pretty")

    # Stdlib utility tests
    if test_json_get_str_or()
        passed = passed + 1
        print("PASS: get_str_or")
    else
        print("FAIL: get_str_or")

    if test_json_get_int_or()
        passed = passed + 1
        print("PASS: get_int_or")
    else
        print("FAIL: get_int_or")

    if test_json_is_empty()
        passed = passed + 1
        print("PASS: is_empty")
    else
        print("FAIL: is_empty")

    if test_json_path()
        passed = passed + 1
        print("PASS: path")
    else
        print("FAIL: path")

    print("")
    print("JSON tests: " + int_to_str(passed) + "/" + int_to_str(total) + " passed")

    if passed == total then 0 else 1
