# Test prepared statements API

f test_prepare_and_execute() -> Bool
    m db_open_memory()
        Ok(db) ->
            m db_execute(db, "CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)")
                Ok(_) ->
                    m db_prepare(db, "INSERT INTO users (name) VALUES (?)")
                        Ok(stmt) ->
                            m db_execute_prepared(stmt, ["Alice"])
                                Ok(_) ->
                                    m db_execute_prepared(stmt, ["Bob"])
                                        Ok(_) ->
                                            m db_execute_prepared(stmt, ["Charlie"])
                                                Ok(_) ->
                                                    m db_query(db, "SELECT COUNT(*) FROM users")
                                                        Ok(rows) ->
                                                            db_close(db)
                                                            vec_len(rows) == 1
                                                        Err(_) -> false
                                                Err(_) -> false
                                        Err(_) -> false
                                Err(_) -> false
                        Err(_) -> false
                Err(_) -> false
        Err(_) -> false

f test_query_prepared() -> Bool
    m db_open_memory()
        Ok(db) ->
            m db_execute(db, "CREATE TABLE items (id INTEGER PRIMARY KEY, name TEXT)")
                Ok(_) ->
                    m db_execute(db, "INSERT INTO items (name) VALUES ('apple'), ('banana'), ('apricot')")
                        Ok(_) ->
                            m db_prepare(db, "SELECT name FROM items WHERE name LIKE ?")
                                Ok(stmt) ->
                                    m db_query_prepared(stmt, ["ap%"])
                                        Ok(rows) ->
                                            db_close(db)
                                            vec_len(rows) == 2
                                        Err(_) -> false
                                Err(_) -> false
                        Err(_) -> false
                Err(_) -> false
        Err(_) -> false

f test_sql_injection_protection() -> Bool
    m db_open_memory()
        Ok(db) ->
            m db_execute(db, "CREATE TABLE secrets (id INTEGER PRIMARY KEY, data TEXT)")
                Ok(_) ->
                    m db_execute(db, "INSERT INTO secrets (data) VALUES ('secret1'), ('secret2')")
                        Ok(_) ->
                            m db_prepare(db, "SELECT * FROM secrets WHERE data = ?")
                                Ok(stmt) ->
                                    malicious_input := "'; DROP TABLE secrets; --"
                                    m db_query_prepared(stmt, [malicious_input])
                                        Ok(rows) ->
                                            m db_query(db, "SELECT * FROM secrets")
                                                Ok(all_rows) ->
                                                    db_close(db)
                                                    vec_len(rows) == 0 && vec_len(all_rows) == 2
                                                Err(_) -> false
                                        Err(_) -> false
                                Err(_) -> false
                        Err(_) -> false
                Err(_) -> false
        Err(_) -> false

f main() -> Int
    passed := 0
    if test_prepare_and_execute() then passed = passed + 1 else print("FAIL: test_prepare_and_execute")
    if test_query_prepared() then passed = passed + 1 else print("FAIL: test_query_prepared")
    if test_sql_injection_protection() then passed = passed + 1 else print("FAIL: test_sql_injection_protection")
    
    print("Prepared statement tests passed:")
    print(passed)
    print("of 3")
    
    if passed == 3 then 0 else 1
